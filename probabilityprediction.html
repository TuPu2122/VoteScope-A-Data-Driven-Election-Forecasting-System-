<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Election Win Predictor</title>

    <!-- Bootstrap Stylesheet for UI Components -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Chart.js Library for All Graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <style>
        /* -------- GLOBAL UI STYLE RESET -------- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* -------- BODY UI STYLING -------- */
        body {
            /* Gradient background for a clean UI feel */
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            padding: 20px;
        }

        /* Maximum width container */
        .container-max {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* -------- HEADER STYLING -------- */
        header {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }

        header h1 {
            color: #333;
            font-weight: 700;
        }

        header p {
            color: #666;
            font-size: 14px;
        }

        /* -------- CARD COMPONENT -------- */
        .card {
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            border-radius: 12px;
            transition: 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.25);
        }

        .card h5 {
            color: #333;
            font-weight: 700;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        /* -------- MONOSPACE TEXT AREAS -------- */
        .monos {
            font-family: 'Monaco', monospace;
            font-size: 12px;
        }

        /* Small note text */
        .small-muted {
            font-size: 12px;
            color: #6b7280;
        }

        /* -------- BUTTON STYLES -------- */
        .btn {
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary { background: #667eea; }
        .btn-success { background: #10b981; }
        .btn-outline-danger { border-color: #ef4444; }

        /* -------- FORM INPUTS -------- */
        .form-control {
            border-radius: 8px;
            padding: 10px;
            font-size: 13px;
        }

        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
        }

        /* -------- DATA TABLE -------- */
        .table th {
            background: #f3f4f6;
            font-weight: 700;
        }

        /* -------- STATS BOXES -------- */
        .stats-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            padding: 15px;
            background: #f9fafb;
            border-radius: 8px;
        }

        .stat-item {
            background: white;
            border-radius: 6px;
            border-left: 4px solid #667eea;
            padding: 10px;
        }

        /* -------- CHARTS -------- */
        .chart-container {
            position: relative;
            height: 250px;
        }

        /* Responsive layout */
        @media(max-width: 768px) {
            .stats-row { grid-template-columns: 1fr; }
        }
    </style>
</head>

<body>
    <div class="container-max">

        <!-- ------ HEADER SECTION (Title + Tagline) ------ -->
        <header>
            <h1>üó≥ Election Win Probability Predictor</h1>
            <p>Train a logistic regression model and predict election outcomes with analytics</p>
        </header>

        <!-- GRID LAYOUT: 3 Columns -->
        <div class="row g-4">

            <!-- ========================= COLUMN 1: DATA + PREDICTION ========================= -->
            <div class="col-lg-4">

                <!-- -------- CSV INPUT CARD -------- -->
                <div class="card p-4">
                    <h5>üìä Dataset (CSV)</h5>

                    <!-- User pastes CSV here -->
                    <textarea id="csvInput" class="form-control monos" rows="10">
votes_received,previous_vote_share,campaign_spending,voter_turnout,candidate_experience,party_seats_held,public_sentiment_score,ground_volunteers,won
100000,35.5,500000,55.0,5,20,0.2,500,0
150000,42.0,800000,62.0,10,30,0.5,800,1
120000,38.5,600000,58.0,7,25,0.3,600,0
180000,45.0,1000000,65.0,15,35,0.6,1000,1
90000,30.0,400000,50.0,3,15,-0.1,400,0
200000,48.0,1200000,68.0,20,40,0.7,1200,1
110000,36.0,550000,57.0,8,22,0.4,550,0
160000,43.5,900000,63.5,12,32,0.55,900,1
95000,32.0,450000,52.0,4,18,0.15,450,0
190000,47.0,1100000,67.0,18,38,0.65,1100,1
                    </textarea>

                    <!-- Buttons: Load, Download, Reset -->
                    <div class="d-flex gap-2 mt-3 flex-wrap">
                        <button id="loadBtn" class="btn btn-primary flex-grow-1">üöÄ Load & Train</button>
                        <button id="downloadCsv" class="btn btn-outline-secondary">‚¨á Download</button>
                        <button id="resetModel" class="btn btn-outline-danger">üîÑ Reset</button>
                    </div>

                    <p class="small-muted mt-2">Paste your election data in CSV format.</p>
                </div>

                <!-- -------- PREDICTION FORM CARD -------- -->
                <div class="card p-4 mt-4">
                    <h5>üîÆ Make a Prediction</h5>

                    <!-- User inputs all 8 features -->
                    <form id="predictForm" class="row g-2">

                        <!-- Each field corresponds to one input feature -->
                        <div class="col-6"><input placeholder="votes_received" name="votes_received" type="number" class="form-control" required></div>
                        <div class="col-6"><input placeholder="previous_vote_share" name="previous_vote_share" type="number" step="0.1" class="form-control" required></div>

                        <div class="col-6"><input placeholder="campaign_spending" name="campaign_spending" type="number" class="form-control" required></div>
                        <div class="col-6"><input placeholder="voter_turnout" name="voter_turnout" type="number" step="0.1" class="form-control" required></div>

                        <div class="col-6"><input placeholder="candidate_experience" name="candidate_experience" type="number" class="form-control" required></div>
                        <div class="col-6"><input placeholder="party_seats_held" name="party_seats_held" type="number" class="form-control" required></div>

                        <div class="col-6"><input placeholder="public_sentiment_score" name="public_sentiment_score" type="number" step="0.1" class="form-control" required></div>
                        <div class="col-6"><input placeholder="ground_volunteers" name="ground_volunteers" type="number" class="form-control" required></div>

                        <div class="col-12"><button class="btn btn-success w-100" type="submit">‚úÖ Predict Won?</button></div>
                    </form>

                    <!-- Prediction result rendered here -->
                    <div id="predictionResult" class="mt-3"></div>
                </div>

            </div>

            <!-- ========================= COLUMN 2: DATA PREVIEW + LOSS + WEIGHTS ========================= -->
            <div class="col-lg-4">

                <!-- -------- DATA TABLE PREVIEW -------- -->
                <div class="card p-4">
                    <h5>üìà Data Preview</h5>

                    <!-- Table loads dynamically from CSV -->
                    <div style="overflow-x:auto; max-height:280px;">
                        <table class="table table-sm mb-0" id="dataTable"></table>
                    </div>

                    <!-- Accuracy + Final Loss -->
                    <div class="stats-row">
                        <div class="stat-item"><b>Training Accuracy:</b><span id="acc">-</span></div>
                        <div class="stat-item"><b>Final Loss:</b><span id="lossVal">-</span></div>
                    </div>
                </div>

                <!-- LOSS CHART -->
                <div class="card p-4 mt-4">
                    <h5>üìâ Training Loss</h5>
                    <div class="chart-container"><canvas id="lossChart"></canvas></div>
                </div>

                <!-- WEIGHTS CHART -->
                <div class="card p-4 mt-4">
                    <h5>‚öñÔ∏è Feature Weights</h5>
                    <canvas id="weightsChart" class="chart-container"></canvas>
                </div>
            </div>

            <!-- ========================= COLUMN 3: ACCURACY + CORRELATION + DISTRIBUTION ========================= -->
            <div class="col-lg-4">

                <div class="card p-4">
                    <h5>üéØ Accuracy Over Time</h5>
                    <div class="chart-container"><canvas id="accuracyChart"></canvas></div>
                </div>

                <div class="card p-4 mt-4">
                    <h5>üîó Feature Correlations</h5>
                    <div class="chart-container"><canvas id="correlationChart"></canvas></div>
                </div>

                <div class="card p-4 mt-4">
                    <h5>üìä Prediction Distribution</h5>
                    <div class="chart-container"><canvas id="distributionChart"></canvas></div>
                </div>

            </div>

        </div>

        <!-- FOOTER -->
        <footer class="mt-4 text-center text-white">
            üåê Logistic Regression ‚Ä¢ Advanced Analytics ‚Ä¢ Built with Chart.js
        </footer>
    </div>

    <script>
        /* =====================================================================
           GLOBAL VARIABLES
        ===================================================================== */
        var model = null;           // Stores trained weights + normalization values
        var prepared = null;        // Stores normalized X,y & stats
        var charts = {};            // Reference to all Chart.js instances


        /* =====================================================================
           CSV PARSER ‚Äî Converts raw CSV text ‚Üí Array of JS objects
        ===================================================================== */
        function parseCSV(txt) {
            var lines = txt.trim().split(/\r?\n/).map(l => l.trim());

            if (lines.length < 2) return [];

            // Extract columns
            var headers = lines[0].split(',').map(h => h.trim());

            // Convert each row into an object
            return lines.slice(1).map(row => {
                var obj = {};
                var cols = row.split(',');

                headers.forEach((h, i) => {
                    var num = Number(cols[i]);
                    obj[h] = isNaN(num) ? cols[i] : num; // convert to number if possible
                });

                return obj;
            });
        }


        /* =====================================================================
           SIGMOID FUNCTION (core of logistic regression)
        ===================================================================== */
        function sigmoid(z) {
            // Overflow protection
            if (z > 500) return 1;
            if (z < -500) return 0;
            return 1 / (1 + Math.exp(-z));
        }


        /* =====================================================================
           NORMALIZE EACH COLUMN ‚Üí (x - mean) / std
        ===================================================================== */
        function normalizeColumns(X) {
            var m = X.length, n = X[0].length;
            var means = [], stds = [];

            for (var j = 0; j < n; j++) {

                // Compute mean
                var s = 0;
                for (var i = 0; i < m; i++) s += X[i][j];
                means[j] = s / m;

                // Compute std dev
                var ss = 0;
                for (var i = 0; i < m; i++) ss += Math.pow(X[i][j] - means[j], 2);
                stds[j] = Math.sqrt(ss / m) || 1;

                // Apply normalization
                for (var i = 0; i < m; i++) {
                    X[i][j] = (X[i][j] - means[j]) / stds[j];
                }
            }

            return { X, means, stds };
        }


        /* =====================================================================
           Extract X, y from dataset and normalize X
        ===================================================================== */
        function prepareXY(data) {

            // Order of features (important!)
            var keys = [
                'votes_received', 'previous_vote_share', 'campaign_spending',
                'voter_turnout', 'candidate_experience', 'party_seats_held',
                'public_sentiment_score', 'ground_volunteers'
            ];

            var X = data.map(row => keys.map(k => row[k]));
            var y = data.map(row => row.won);

            var norm = normalizeColumns(X);

            return { X: norm.X, y, means: norm.means, stds: norm.stds, keys };
        }


        /* =====================================================================
           Predict probability using logistic regression formula:
           p = sigmoid(w0 + w1*x1 + ... + wn*xn)
        ===================================================================== */
        function predictProb(weights, x) {
            var z = weights[0]; // bias
            for (var i = 0; i < x.length; i++) z += weights[i + 1] * x[i];
            return sigmoid(z);
        }


        /* =====================================================================
           TRAIN LOGISTIC REGRESSION USING GRADIENT DESCENT
        ===================================================================== */
        function trainLogistic(X, y, opts) {

            var lr = opts.lr || 0.1;
            var epochs = opts.epochs || 1000;
            var m = X.length, n = X[0].length;

            // weights = random small numbers
            var w = Array(n + 1).fill(0).map(() => Math.random() * 0.02 - 0.01);

            var lossHistory = [];
            var accuracyHistory = [];

            for (var ep = 0; ep < epochs; ep++) {
                var grads = Array(n + 1).fill(0);
                var loss = 0, correct = 0;

                // ---- Loop through training examples ----
                for (var i = 0; i < m; i++) {

                    var p = predictProb(w, X[i]);
                    var err = p - y[i];

                    // Cross-entropy loss accumulate
                    loss += -(y[i] * Math.log(Math.max(p, 1e-15)) +
                              (1 - y[i]) * Math.log(Math.max(1 - p, 1e-15)));

                    // Accuracy update
                    if ((p >= 0.5 ? 1 : 0) === y[i]) correct++;

                    // Gradient update: bias
                    grads[0] += err;

                    // Gradient: weights
                    for (var j = 0; j < n; j++) grads[j + 1] += err * X[i][j];
                }

                // ---- Apply gradient descent update ----
                for (var j = 0; j < grads.length; j++) {
                    w[j] -= (lr / m) * grads[j];
                }

                // Store loss + accuracy per epoch
                lossHistory.push(loss / m);
                accuracyHistory.push(correct / m);
            }

            return { weights: w, lossHistory, accuracyHistory };
        }


        /* =====================================================================
           Evaluate model: compute accuracy + store predicted probs
        ===================================================================== */
        function evaluate(X, y, weights) {
            var correct = 0;
            var probs = [];

            for (var i = 0; i < X.length; i++) {
                var p = predictProb(weights, X[i]);
                probs.push(p);
                if ((p >= 0.5 ? 1 : 0) === y[i]) correct++;
            }

            return { acc: correct / X.length, probs };
        }


        /* =====================================================================
           Calculate correlation between each feature and target y
        ===================================================================== */
        function calculateCorrelations(X, y, keys) {
            var corrs = [];
            var n = X.length;

            for (var j = 0; j < keys.length; j++) {
                var feat = X.map(r => r[j]);

                var mx = feat.reduce((a, b) => a + b, 0) / n;
                var my = y.reduce((a, b) => a + b, 0) / n;

                var num = 0, dx = 0, dy = 0;

                for (var i = 0; i < n; i++) {
                    num += (feat[i] - mx) * (y[i] - my);
                    dx += Math.pow(feat[i] - mx, 2);
                    dy += Math.pow(y[i] - my, 2);
                }

                corrs.push({
                    feature: keys[j],
                    correlation: num / (Math.sqrt(dx) * Math.sqrt(dy))
                });
            }
            return corrs;
        }


        /* =====================================================================
           Helper: delete previous Chart.js chart before drawing a new one
        ===================================================================== */
        function destroyChart(name) {
            if (charts[name]) { charts[name].destroy(); delete charts[name]; }
        }


        /* =====================================================================
           CHART FUNCTIONS (Loss, Accuracy, Weights, Correlation, Distribution)
        ===================================================================== */
        function plotLoss(data) {
            destroyChart('loss');
            charts.loss = new Chart(document.getElementById('lossChart'), {
                type: 'line',
                data: {
                    labels: data.map((_, i) => i + 1),
                    datasets: [{
                        label: 'Loss',
                        data,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102,126,234,0.1)',
                        borderWidth: 2,
                        tension: 0.4
                    }]
                }
            });
        }

        function plotAccuracy(data) {
            destroyChart('accuracy');
            charts.accuracy = new Chart(document.getElementById('accuracyChart'), {
                type: 'line',
                data: {
                    labels: data.map((_, i) => i + 1),
                    datasets: [{
                        label: 'Accuracy (%)',
                        data: data.map(v => v * 100),
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16,185,129,0.1)',
                        borderWidth: 2
                    }]
                }
            });
        }

        function plotWeights(weights, keys) {
            destroyChart('weights');
            var labels = ['bias'].concat(keys);

            charts.weights = new Chart(document.getElementById('weightsChart'), {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: 'Weight',
                        data: weights,
                        backgroundColor: weights.map(w => w >= 0 ? 'rgba(16,185,129,0.8)' : 'rgba(239,68,68,0.8)')
                    }]
                }
            });
        }

        function plotCorrelations(corrs) {
            destroyChart('corr');

            var sorted = corrs.slice().sort((a, b) => Math.abs(b.correlation) - Math.abs(a.correlation));

            charts.corr = new Chart(document.getElementById('correlationChart'), {
                type: 'bar',
                data: {
                    labels: sorted.map(c => c.feature),
                    datasets: [{
                        data: sorted.map(c => c.correlation),
                        backgroundColor: sorted.map(c => c.correlation >= 0 ? 'rgba(102,126,234,0.8)' : 'rgba(239,68,68,0.8)')
                    }]
                }
            });
        }

        function plotDistribution(probs, y) {
            destroyChart('dist');

            var bins = 10;
            var win = Array(bins).fill(0);
            var lose = Array(bins).fill(0);

            for (var i = 0; i < probs.length; i++) {
                var idx = Math.floor(probs[i] * bins);
                if (idx >= bins) idx = bins - 1;

                y[i] === 1 ? win[idx]++ : lose[idx]++;
            }

            charts.dist = new Chart(document.getElementById('distributionChart'), {
                type: 'bar',
                data: {
                    labels: Array(bins).fill(0).map((_, i) => `${i * 10}-${(i + 1) * 10}%`),
                    datasets: [
                        { label: 'Won', data: win, backgroundColor: 'rgba(16,185,129,0.8)' },
                        { label: 'Lost', data: lose, backgroundColor: 'rgba(239,68,68,0.8)' }
                    ]
                }
            });
        }


        /* =====================================================================
           RENDER DATA TABLE
        ===================================================================== */
        function renderTable(data) {
            var table = document.getElementById('dataTable');
            table.innerHTML = "";

            if (!data.length) return;

            var headers = Object.keys(data[0]);

            // Header row
            table.innerHTML = `<thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>`;

            var body = document.createElement('tbody');

            // Data rows
            data.forEach(row => {
                var tr = document.createElement('tr');
                headers.forEach(h => {
                    var td = document.createElement('td');
                    td.textContent = typeof row[h] === "number" ? row[h].toFixed(2) : row[h];
                    tr.appendChild(td);
                });
                body.appendChild(tr);
            });

            table.appendChild(body);
        }


        /* =====================================================================
           MAIN TRAINING WORKFLOW
        ===================================================================== */
        function loadAndTrain() {
            try {
                var raw = parseCSV(document.getElementById('csvInput').value);

                if (raw.length < 2) return alert("Dataset invalid!");

                // Display data in table
                renderTable(raw);

                // Convert raw ‚Üí normalized XY
                prepared = prepareXY(raw);

                // Find feature correlations
                var corrs = calculateCorrelations(prepared.X, prepared.y, prepared.keys);

                // Train model using logistic regression
                var trained = trainLogistic(prepared.X, prepared.y, { lr: 0.5, epochs: 1200 });

                // Store final model
                model = {
                    weights: trained.weights,
                    means: prepared.means,
                    stds: prepared.stds,
                    keys: prepared.keys
                };

                // Evaluate model
                var results = evaluate(prepared.X, prepared.y, model.weights);

                // Update UI
                document.getElementById('acc').textContent = (results.acc * 100).toFixed(2) + "%";
                document.getElementById('lossVal').textContent = trained.lossHistory.at(-1).toFixed(4);

                // Draw all charts
                plotLoss(trained.lossHistory);
                plotAccuracy(trained.accuracyHistory);
                plotWeights(model.weights, prepared.keys);
                plotCorrelations(corrs);
                plotDistribution(results.probs, prepared.y);

            } catch (err) {
                alert("Error: " + err.message);
            }
        }


        /* =====================================================================
           RESET MODEL + CHARTS
        ===================================================================== */
        function resetModel() {
            model = null;
            prepared = null;

            document.getElementById('acc').textContent = "-";
            document.getElementById('lossVal').textContent = "-";

            // Destroy all charts
            Object.keys(charts).forEach(key => destroyChart(key));
        }


        /* =====================================================================
           PREDICT BUTTON HANDLER
        ===================================================================== */
        function predictFromForm(ev) {
            ev.preventDefault();

            if (!model) return alert("Train model first!");

            var form = new FormData(ev.target);

            // Extract inputs in correct order
            var x = prepared.keys.map(k => Number(form.get(k)));

            // Apply normalization
            var nx = x.map((val, i) => (val - model.means[i]) / model.stds[i]);

            // Predict probability
            var p = predictProb(model.weights, nx);

            document.getElementById('predictionResult').innerHTML =
                `<div class="alert alert-success">
                    <b>Prediction:</b> ${p >= 0.5 ? "Yes (Win)" : "No (Lose)"}<br>
                    Probability: ${(p * 100).toFixed(1)}%
                </div>`;
        }


        /* =====================================================================
           ON WINDOW LOAD ‚Äî Setup all listeners + Render initial table
        ===================================================================== */
        window.addEventListener('load', function () {

            // Load table with default CSV
            renderTable(parseCSV(document.getElementById('csvInput').value));

            // Add event listeners
            document.getElementById('loadBtn').addEventListener('click', loadAndTrain);
            document.getElementById('resetModel').addEventListener('click', resetModel);

            // CSV download
            document.getElementById('downloadCsv').addEventListener('click', () => {
                var blob = new Blob([document.getElementById('csvInput').value], { type: "text/csv" });
                var url = URL.createObjectURL(blob);

                var a = document.createElement("a");
                a.href = url;
                a.download = "election_data.csv";
                a.click();
            });

            document.getElementById('predictForm').addEventListener('submit', predictFromForm);
        });
    </script>

</body>
</html>
